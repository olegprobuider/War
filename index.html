<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emoji Geo-Strategy (one-file)</title>
<style>
  :root{
    --bg:#0f1724; --panel:#0b1320; --muted:#94a3b8; --accent:#60a5fa;
    --card:#071129; --glass: rgba(255,255,255,0.03);
  }
  body{
    margin:0; font-family: Inter, system-ui, sans-serif; background:linear-gradient(180deg,#021025,#03182b);
    color:#e6eef8;
    display:flex; gap:12px; height:100vh; padding:12px; box-sizing:border-box;
  }
  .left{width:640px; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .right{flex:1; background:var(--panel); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:12px}
  h1{margin:0 0 6px 0; font-size:18px}
  .map{display:grid; grid-template-columns: repeat(16, 1fr); gap:6px; user-select:none}
  .tile{height:36px; display:flex; align-items:center; justify-content:center; font-size:18px; border-radius:6px; background:var(--glass); cursor:pointer}
  .tile.city{background:linear-gradient(90deg,#10466a,#0b2b46); box-shadow: inset 0 -4px 8px rgba(0,0,0,0.4)}
  .tile.enemy{background:linear-gradient(90deg,#3b0b0b,#1e0505)}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{background:linear-gradient(180deg,#15384f,#0f2a38); padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.04)}
  .btn.secondary{background:linear-gradient(180deg,#2c2f3a,#121214); color:var(--muted)}
  .panel{background:rgba(255,255,255,0.02); padding:10px; border-radius:10px}
  .country-list{display:flex; gap:6px; flex-wrap:wrap}
  .flag{padding:6px 8px; border-radius:8px; cursor:pointer; background:rgba(255,255,255,0.02)}
  .flag.selected{outline:2px solid #60a5fa}
  .stats{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
  .stat{background:rgba(255,255,255,0.02); padding:8px; border-radius:8px}
  .big{font-size:20px; font-weight:700}
  .log{background:rgba(0,0,0,0.3); padding:8px; border-radius:8px; max-height:180px; overflow:auto; font-size:13px}
  .row{display:flex; gap:8px; align-items:center}
  .upgrade{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background:rgba(255,255,255,0.01)}
  footer{font-size:12px; color:var(--muted)}
  .grid-row{display:flex; gap:6px}
  .selectedInfo{border:1px dashed rgba(255,255,255,0.04); padding:8px; border-radius:8px}
  .muted{color:var(--muted); font-size:13px}
  input[type=range]{width:100%}
</style>
</head>
<body>
  <div class="left">
    <h1>üåç Emoji Geo-Strategy ‚Äî –∫–∞—Ä—Ç–∞</h1>
    <div class="panel" style="margin-bottom:8px">
      <div class="controls">
        <div class="btn" id="newGameBtn">üÜï –ù–æ–≤–∞—è –∏–≥—Ä–∞</div>
        <div class="btn secondary" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</div>
        <div class="btn secondary" id="loadBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
        <div style="margin-left:auto" class="muted">Tick = <span id="tickIntervalLabel">5s</span></div>
      </div>
    </div>

    <div style="display:flex; gap:8px; margin-bottom:8px">
      <div style="flex:1" class="panel">
        <div class="muted">–í—ã–±–µ—Ä–∏ —Å—Ç—Ä–∞–Ω—É</div>
        <div class="country-list" id="countryList"></div>
      </div>
      <div style="width:220px" class="panel">
        <div class="muted">–ò–≥—Ä–æ–∫</div>
        <div class="big" id="playerName">–ò–≥—Ä–æ–∫</div>
        <div class="muted">–ë–∞–ª–∞–Ω—Å</div>
        <div class="big" id="playerMoney">0</div>
      </div>
    </div>

    <div class="map" id="map"></div>
    <div style="margin-top:8px" class="muted">–õ–µ–≥–µ–Ω–¥–∞: üü© –Ω–µ–π—Ç—Ä–∞–ª, üü¶ –≤–æ–¥–∞, üá®üá≥/... —Å—Ç—Ä–∞–Ω—ã. –ù–∞–∂–º–∏ –Ω–∞ –∫–ª–µ—Ç–∫—É –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.</div>
  </div>

  <div class="right">
    <div class="panel">
      <h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ</h1>
      <div id="selectedInfo" class="selectedInfo muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏–ª–∏ –∫–ª–µ—Ç–∫—É –∫–∞—Ä—Ç—ã.</div>
    </div>

    <div class="panel">
      <h1>–ê–ø–≥—Ä–µ–π–¥—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è</h1>
      <div id="actions">
        <div class="muted">–ù–∏ –æ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.</div>
      </div>
    </div>

    <div class="panel">
      <h1>–õ–æ–≥</h1>
      <div class="log" id="log"></div>
    </div>

    <div style="display:flex; gap:8px;">
      <div class="panel" style="flex:1">
        <div class="muted">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ / —Ö–æ–¥</div>
        <div class="big" id="incomePerTick">0</div>
      </div>
      <div class="panel" style="width:220px">
        <div class="muted">–í—Ä–µ–º—è (tick)</div>
        <div class="big" id="tickCount">0</div>
      </div>
    </div>

    <footer>–°–¥–µ–ª–∞–Ω–æ –æ–¥–Ω–∏–º html. –†–µ–¥–∞–∫—Ç–∏—Ä—É–π –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞.</footer>
  </div>

<script>
/*
  Emoji Geo-Strategy
  Single-file prototype.
  –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: —Å—Ç—Ä–∞–Ω—ã, –∏–≥—Ä–æ–∫, –¥–µ–Ω—å–≥–∏, –∞–ø–≥—Ä–µ–π–¥—ã, –∞—Ç–∞–∫–∏, –∑–∞—Ö–≤–∞—Ç, –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥.
*/

// *** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–ª–∞–Ω—Å–∞ (–º–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å) ***
const CONFIG = {
  gridW: 16,
  gridH: 10,
  startMoney: 500,
  tickSeconds: 5,
  baseIncome: 5, // –¥–æ—Ö–æ–¥ –æ—Ç —Å–≤–æ–µ–π —Å—Ç—Ä–∞–Ω—ã 1 —É—Ä–æ–≤–Ω—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  infrastructureIncomeMultiplier: 10, // + per level
  infrastructureCostBase: 100,
  militaryCostBase: 80,
  unitCostBase: {ship:120, plane:200, train:90},
  policeCostBase: 150,
  revoltBaseChance: 0.5, // 50% chance –ø–æ–ø—ã—Ç–∫–∏ –±—É–Ω—Ç–∞ –¥–ª—è –∑–∞—Ö–≤–∞—á–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏
  policeEffectPerLevel: 0.15, // —É–º–µ–Ω—å—à–∞–µ—Ç —à–∞–Ω—Å –±—É–Ω—Ç–∞ (15% per police level)
  attackIntervalSeconds: 0, // not used; attacks are immediate
  captureTaxPercent: 0.2 // percent of captured country's income goes to owner (passive)
};

// *** –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω (emoji, name) ***
const COUNTRY_OPTIONS = [
  {code:"CN", flag:"üá®üá≥", name:"–ö–∏—Ç–∞–π"},
  {code:"FR", flag:"üá´üá∑", name:"–§—Ä–∞–Ω—Ü–∏—è"},
  {code:"GB", flag:"üá¨üáß", name:"–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è"},
  {code:"PL", flag:"üáµüá±", name:"–ü–æ–ª—å—à–∞"},
  {code:"US", flag:"üá∫üá∏", name:"–°–®–ê"},
  {code:"UA", flag:"üá∫üá¶", name:"–£–∫—Ä–∞–∏–Ω–∞"},
  {code:"AE", flag:"üá¶üá™", name:"–û–ê–≠"},
  {code:"AI", flag:"üá¶üáÆ", name:"–ê–Ω–≥–∏–ª—å—è"},
  {code:"IE", flag:"üáÆüá™", name:"–ò—Ä–ª–∞–Ω–¥–∏—è"},
  {code:"IT", flag:"üáÆüáπ", name:"–ò—Ç–∞–ª–∏—è"},
  {code:"KZ", flag:"üá∞üáø", name:"–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω"},
  {code:"RU", flag:"üá∑üá∫", name:"–†–æ—Å—Å–∏—è"}
];

// *** –ò–≥—Ä–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ***
let state = {
  grid: [], // tiles
  countries: {}, // countryId -> data
  player: {id:null, money:0, name:"–ò–≥—Ä–æ–∫", owned:[]},
  tick: 0,
  intervalId: null
};

// —É—Ç–∏–ª–∏—Ç—ã
function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a }
function log(msg){ const l = document.getElementById('log'); const time = new Date().toLocaleTimeString(); l.innerHTML = `<div>(${time}) ${escapeHtml(msg)}</div>` + l.innerHTML; }
function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;"); }

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã: —Å–æ–∑–¥–∞—ë–º gridW*gridH –∫–ª–µ—Ç–æ–∫, —Ä–∞–∑–º–µ—â–∞–µ–º —Å—Ç—Ä–∞–Ω—ã —Ä–∞–Ω–¥–æ–º–Ω–æ
function initNewGame(){
  state = {grid:[], countries:{}, player:{id:null,money:CONFIG.startMoney,name:"–ò–≥—Ä–æ–∫",owned:[]}, tick:0, intervalId:null};
  // create tiles
  const total = CONFIG.gridW * CONFIG.gridH;
  for(let i=0;i<total;i++){
    // –Ω–µ–º–Ω–æ–≥–æ –≤–æ–¥—ã
    const isWater = Math.random() < 0.12;
    state.grid.push({type: isWater ? 'sea' : 'land', country:null});
  }
  // place some countries on different land tiles
  const landIndices = state.grid.map((t,i)=>({t,i})).filter(x=>x.t.type==='land').map(x=>x.i);
  shuffleArray(landIndices);
  const count = Math.min(COUNTRY_OPTIONS.length, Math.floor(landIndices.length/4));
  for(let i=0;i<count;i++){
    const pos = landIndices[i];
    const cOpt = COUNTRY_OPTIONS[i];
    const id = cOpt.code;
    state.grid[pos].country = id;
    // initial stats for country
    state.countries[id] = {
      id, flag:cOpt.flag, name:cOpt.name,
      pos,
      owner: null, // null = neutral, 'player' = player, or other player id (not used)
      infra: rnd(1,2),
      military: rnd(0,2),
      units: {ship:0, plane:0, train:0},
      police: 0,
      baseIncome: rnd(5,20)
    };
  }
  // place player ownership on one country (first)
  const firstId = Object.keys(state.countries)[0];
  if(firstId){
    state.countries[firstId].owner = 'player';
    state.player.id = 'player';
    state.player.owned = [firstId];
  }
  saveToLocalStorage('autosave', state);
  renderAll();
  startTick();
  log('–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∏–≥—Ä–∞.');
}

// shuffle helper
function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } }

// rendering
function renderAll(){
  renderCountryList();
  renderMap();
  renderPlayerInfo();
  renderSidebar();
  renderIncome();
}
function renderMap(){
  const mapDiv = document.getElementById('map');
  mapDiv.innerHTML = '';
  for(let y=0;y<CONFIG.gridH;y++){
    for(let x=0;x<CONFIG.gridW;x++){
      const idx = y*CONFIG.gridW + x;
      const tile = state.grid[idx];
      const el = document.createElement('div');
      el.className = 'tile';
      el.dataset.idx = idx;
      if(tile.type === 'sea'){ el.innerText = 'üü¶'; el.classList.add('sea') }
      else if(tile.country){
        const c = state.countries[tile.country];
        el.innerText = c.flag;
        el.classList.add('city');
        if(c.owner && c.owner !== 'player') el.classList.add('enemy');
      } else {
        el.innerText = 'üü©';
      }
      el.onclick = ()=>onTileClick(idx);
      mapDiv.appendChild(el);
    }
  }
}
function renderCountryList(){
  const cl = document.getElementById('countryList'); cl.innerHTML='';
  for(const id in state.countries){
    const c = state.countries[id];
    const el = document.createElement('div');
    el.className = 'flag' + (c.owner==='player' ? ' selected' : '');
    el.innerHTML = `${c.flag} <span class="muted" style="font-size:12px"> ${c.name}</span>`;
    el.onclick = ()=>selectCountry(id);
    cl.appendChild(el);
  }
}
function renderPlayerInfo(){
  document.getElementById('playerName').innerText = state.player.name;
  document.getElementById('playerMoney').innerText = formatMoney(state.player.money);
}
function renderSidebar(){
  const info = document.getElementById('selectedInfo');
  if(state._selectedCountry){
    const c = state.countries[state._selectedCountry];
    info.classList.remove('muted');
    info.innerHTML = `<div style="display:flex;align-items:center;gap:8px">
      <div style="font-size:28px">${c.flag}</div>
      <div>
        <div style="font-weight:700">${c.name} ${c.owner==='player' ? '(–≤–∞—à–∞)' : c.owner ? '(–≤—Ä–∞–∂–¥–µ–±–Ω–∞)' : '(–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞)'}</div>
        <div class="muted">–ò–Ω—Ñ—Ä–∞: ${c.infra} | –í–æ–µ–Ω–Ω—ã–µ: ${c.military} | üëÆ –ø–æ–ª–∏—Ü–∏—è: ${c.police}</div>
        <div class="muted">–Æ–Ω–∏—Ç—ã: üõ≥Ô∏è${c.units.ship} ‚úàÔ∏è${c.units.plane} üöÇ${c.units.train}</div>
        <div class="muted">–ë–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥: ${c.baseIncome} </div>
      </div>
    </div>`;
    renderActionsFor(c);
  } else {
    info.classList.add('muted');
    info.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ —Å–ª–µ–≤–∞.';
    document.getElementById('actions').innerHTML = '<div class="muted">–ù–∏ –æ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.</div>';
  }
}
function renderActionsFor(country){
  const a = document.getElementById('actions');
  a.innerHTML = '';
  const owner = country.owner;
  // show stats & upgrade buttons
  const upgradePanel = document.createElement('div');
  upgradePanel.innerHTML = `
    <div class="row" style="margin-bottom:6px">
      <div style="flex:1">
        <div class="muted">–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ üè≠ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥)</div>
        <div class="upgrade">
          <div>–£—Ä–æ–≤–µ–Ω—å: ${country.infra}</div>
          <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceForInfra(country.infra)}</div>
        </div>
      </div>
      <div style="width:140px; display:flex; flex-direction:column; gap:6px">
        <button class="btn" id="buyInfra">–ö—É–ø–∏—Ç—å</button>
      </div>
    </div>
    <div class="row" style="margin-bottom:6px">
      <div style="flex:1">
        <div class="muted">–í–æ–µ–Ω–Ω—ã–µ üíÇ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∏–ª—É –∞—Ç–∞–∫–∏)</div>
        <div class="upgrade">
          <div>–£—Ä–æ–≤–µ–Ω—å: ${country.military}</div>
          <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceForMilitary(country.military)}</div>
        </div>
      </div>
      <div style="width:140px; display:flex; flex-direction:column; gap:6px">
        <button class="btn" id="buyMilitary">–ù–∞–±—Ä–∞—Ç—å</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:6px">
      <div style="flex:1">
        <div class="muted">–Æ–Ω–∏—Ç—ã</div>
        <div class="upgrade">üõ≥Ô∏è ${country.units.ship} | ‚úàÔ∏è ${country.units.plane} | üöÇ ${country.units.train}</div>
      </div>
      <div style="width:140px;display:flex;flex-direction:column;gap:6px">
        <button class="btn" id="buyShip">–ö—É–ø–∏—Ç—å üõ≥Ô∏è (${CONFIG.unitCostBase.ship})</button>
        <button class="btn" id="buyPlane">–ö—É–ø–∏—Ç—å ‚úàÔ∏è (${CONFIG.unitCostBase.plane})</button>
        <button class="btn" id="buyTrain">–ö—É–ø–∏—Ç—å üöÇ (${CONFIG.unitCostBase.train})</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:6px">
      <div style="flex:1">
        <div class="muted">–ü–æ–ª–∏—Ü–∏—è üëÆ (—É–º–µ–Ω—å—à–∞–µ—Ç —à–∞–Ω—Å –±—É–Ω—Ç–∞)</div>
        <div class="upgrade">–£—Ä–æ–≤–µ–Ω—å: ${country.police} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceForPolice(country.police)}</div>
      </div>
      <div style="width:140px;display:flex;flex-direction:column;gap:6px">
        <button class="btn" id="buyPolice">–ù–∞–Ω—è—Ç—å üëÆ</button>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="attackBtn">‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
      <button class="btn secondary" id="inspectBtn">üîé –°–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏</button>
    </div>
  `;
  a.appendChild(upgradePanel);

  // handlers
  document.getElementById('buyInfra').onclick = ()=>{
    if(country.owner !== 'player'){ alert('–ê–ø–≥—Ä–µ–π–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–∏—Ö —Å—Ç—Ä–∞–Ω.'); return; }
    const cost = priceForInfra(country.infra);
    if(state.player.money < cost){ alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
    state.player.money -= cost; country.infra += 1;
    log(`–í—ã –ø—Ä–æ–∫–∞—á–∞–ª–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ ${country.name} (—É—Ä–æ–≤–µ–Ω—å —Ç–µ–ø–µ—Ä—å ${country.infra}).`);
    saveToLocalStorage('autosave', state); renderAll();
  };
  document.getElementById('buyMilitary').onclick = ()=>{
    if(country.owner !== 'player'){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–∏—Ö —Å—Ç—Ä–∞–Ω.'); return; }
    const cost = priceForMilitary(country.military);
    if(state.player.money < cost){ alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
    state.player.money -= cost; country.military += 1;
    log(`–í—ã —É–≤–µ–ª–∏—á–∏–ª–∏ –≤–æ–µ–Ω–Ω—É—é —Å–∏–ª—É ${country.name} –¥–æ ${country.military}.`);
    saveToLocalStorage('autosave', state); renderAll();
  };
  document.getElementById('buyShip').onclick = ()=>buyUnit(country,'ship');
  document.getElementById('buyPlane').onclick = ()=>buyUnit(country,'plane');
  document.getElementById('buyTrain').onclick = ()=>buyUnit(country,'train');
  document.getElementById('buyPolice').onclick = ()=>{
    if(country.owner !== 'player'){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–∏—Ö —Å—Ç—Ä–∞–Ω.'); return; }
    const cost = priceForPolice(country.police);
    if(state.player.money < cost){ alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
    state.player.money -= cost; country.police += 1;
    log(`–í—ã –ø–æ–≤—ã—Å–∏–ª–∏ –ø–æ–ª–∏—Ü–∏—é –≤ ${country.name} –¥–æ —É—Ä–æ–≤–Ω—è ${country.police}.`);
    saveToLocalStorage('autosave', state); renderAll();
  };
  document.getElementById('attackBtn').onclick = ()=>onAttack(country);
  document.getElementById('inspectBtn').onclick = ()=>alert(JSON.stringify(country,null,2));
}

function buyUnit(country, type){
  if(country.owner !== 'player'){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–∏—Ö —Å—Ç—Ä–∞–Ω.'); return; }
  const cost = CONFIG.unitCostBase[type];
  if(state.player.money < cost){ alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
  state.player.money -= cost; country.units[type] += 1;
  log(`–ö—É–ø–ª–µ–Ω ${type} –≤ ${country.name}.`);
  saveToLocalStorage('autosave', state); renderAll();
}

function onTileClick(idx){
  const tile = state.grid[idx];
  if(tile.country){
    selectCountry(tile.country);
  } else {
    state._selectedCountry = null;
    renderSidebar();
  }
}

function selectCountry(id){
  state._selectedCountry = id;
  renderSidebar();
}

// price calc
function priceForInfra(current){ return Math.round(CONFIG.infrastructureCostBase * Math.pow(1.5, current-1)); }
function priceForMilitary(current){ return Math.round(CONFIG.militaryCostBase * Math.pow(1.6, current)); }
function priceForPolice(current){ return Math.round(CONFIG.policeCostBase * Math.pow(1.8, current)); }

// attack logic: –∞—Ç–∞–∫—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É (–µ—Å–ª–∏ –∞—Ç–∞–∫—É–µ–º –∏–∑ —Å–≤–æ–µ–π —Å—Ç—Ä–∞–Ω—ã –Ω–∞ —Å–æ—Å–µ–¥–Ω—é—é? –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –∞—Ç–∞–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—Ç –≤–∞—à–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–µ–π—Ç—Ä–∞–ª—å/–≤—Ä–∞–∂–¥–µ–±–Ω—É—é)
// We'll prompt: choose attacker (one of player's countries) and target (selected country)
function onAttack(target){
  if(!state._selectedCountry) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –Ω–∞ –∫–∞—Ä—Ç–µ.'); return; }
  // choose an attacker from player's owned (simple: if target is not owned by player, let user pick)
  if(target.owner === 'player'){ alert('–ù–µ–ª—å–∑—è –∞—Ç–∞–∫–æ–≤–∞—Ç—å —Å–≤–æ—é —Å—Ç—Ä–∞–Ω—É.'); return; }
  const playerOwned = state.player.owned;
  if(playerOwned.length===0){ alert('–£ –≤–∞—Å –Ω–µ—Ç —Å–≤–æ–∏—Ö —Å—Ç—Ä–∞–Ω –¥–ª—è –∞—Ç–∞–∫–∏.'); return; }
  let attackerId = playerOwned[0]; // default first
  if(playerOwned.length>1){
    const pick = prompt('–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ç–∞–∫—É—é—â—É—é —Å—Ç—Ä–∞–Ω—É (–≤–≤–µ–¥–∏—Ç–µ –∏–Ω–¥–µ–∫—Å):\n' + playerOwned.map((id,i)=>`${i}: ${state.countries[id].flag} ${state.countries[id].name}`).join('\n'));
    const p = parseInt(pick);
    if(isNaN(p) || p<0 || p>=playerOwned.length){ alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω—É.'); attackerId = playerOwned[0]; }
    else attackerId = playerOwned[p];
  }
  const attacker = state.countries[attackerId];
  const defender = target;

  // compute strengths: base military + units weighted
  const atkStrength = attacker.military * 10 + attacker.units.ship*6 + attacker.units.plane*12 + attacker.units.train*4 + rnd(0,10);
  const defStrength = defender.military * 10 + defender.units.ship*6 + defender.units.plane*12 + defender.units.train*4 + rnd(0,10);

  log(`–ê—Ç–∞–∫–∞: ${attacker.name} (—Å–∏–ª—ã ${atkStrength}) -> ${defender.name} (—Å–∏–ª—ã ${defStrength})`);

  // probabilistic outcome: P(win) = atk/(atk+def)
  const prob = atkStrength / Math.max(1, atkStrength + defStrength);
  const roll = Math.random();
  if(roll < prob){
    // success: capture
    // costs: lose some units / money?
    defender.owner = 'player';
    state.player.owned.push(defender.id);
    // attacker loses some military and units
    const lostMil = Math.max(0, Math.floor(attacker.military * (0.2 + Math.random()*0.3)));
    attacker.military = Math.max(0, attacker.military - lostMil);
    // reduce some defender units as well
    defender.military = Math.max(0, Math.floor(defender.military * 0.4));
    // transfer partial income: passive income will include captured country's baseIncome
    log(`–£—Å–ø–µ—à–Ω–æ! ${defender.name} –∑–∞—Ö–≤–∞—á–µ–Ω–∞. –ü–æ—Ç–µ—Ä—è –≤–æ–∏ÃÜ—Å–∫: ${lostMil}.`);
    // small immediate loot
    const loot = Math.round(defender.baseIncome * 3);
    state.player.money += loot;
    log(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –Ω–∞–ª–æ–≥/–¥–æ–±—ã—á—É: ${loot}.`);
    saveToLocalStorage('autosave', state); renderAll();
  } else {
    // failed: attacker loses more
    const lostMil = Math.max(1, Math.floor(attacker.military * (0.3 + Math.random()*0.4)));
    attacker.military = Math.max(0, attacker.military - lostMil);
    // maybe defender also loses some
    defender.military = Math.max(0, Math.floor(defender.military * (0.1 + Math.random()*0.2)));
    // cost of war
    const warCost = Math.round(atkStrength*0.5);
    state.player.money = Math.max(0, state.player.money - warCost);
    log(`–ê—Ç–∞–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞. –í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ ${lostMil} –≤–æ–µ–Ω–Ω—ã—Ö –∏ ${warCost} –¥–µ–Ω–µ–≥.`);
    saveToLocalStorage('autosave', state); renderAll();
  }
}

// income calc per tick
function computeIncomePerTick(){
  let total = 0;
  for(const id in state.countries){
    const c = state.countries[id];
    if(c.owner === 'player'){
      total += CONFIG.baseIncome + c.infra * CONFIG.infrastructureIncomeMultiplier + c.baseIncome;
      // captured countries contribute via their baseIncome too
    }
  }
  return total;
}

function tick(){
  state.tick++;
  // passive income: sum over owned countries, plus a percent from captured ones (all owned considered captured if owner==='player')
  let income=0;
  state.player.owned =
