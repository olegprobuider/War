<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Emoji Geo-Strategy</title>
    <style>
        :root{
            --bg:#0f1724; --panel:#0b1320; --muted:#94a3b8; --accent:#60a5fa;
            --card:#071129; --glass: rgba(255,255,255,0.03);
        }
        body{
            margin:0; font-family: Inter, system-ui, sans-serif; background:linear-gradient(180deg,#021025,#03182b);
            color:#e6eef8;
            display:flex; gap:12px; height:100vh; padding:12px; box-sizing:border-box;
        }
        .left{width:640px; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.6)}
        .right{flex:1; background:var(--panel); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:12px}
        h1{margin:0 0 6px 0; font-size:18px}
        .map{display:grid; grid-template-columns: repeat(16, 1fr); gap:6px; user-select:none}
        .tile{height:36px; display:flex; align-items:center; justify-content:center; font-size:18px; border-radius:6px; background:var(--glass); cursor:pointer}
        .tile.city{background:linear-gradient(90deg,#10466a,#0b2b46); box-shadow: inset 0 -4px 8px rgba(0,0,0,0.4)}
        .tile.enemy{background:linear-gradient(90deg,#3b0b0b,#1e0505)}
        .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
        .btn{background:linear-gradient(180deg,#15384f,#0f2a38); padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.04)}
        .btn.secondary{background:linear-gradient(180deg,#2c2f3a,#121214); color:var(--muted)}
        .panel{background:rgba(255,255,255,0.02); padding:10px; border-radius:10px}
        .country-list{display:flex; gap:6px; flex-wrap:wrap}
        .flag{padding:6px 8px; border-radius:8px; cursor:pointer; background:rgba(255,255,255,0.02)}
        .flag.selected{outline:2px solid #60a5fa}
        .stats{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
        .stat{background:rgba(255,255,255,0.02); padding:8px; border-radius:8px}
        .big{font-size:20px; font-weight:700}
        .log{background:rgba(0,0,0,0.3); padding:8px; border-radius:8px; max-height:180px; overflow:auto; font-size:13px}
        .row{display:flex; gap:8px; align-items:center}
        .upgrade{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background:rgba(255,255,255,0.01)}
        footer{font-size:12px; color:var(--muted)}
        .grid-row{display:flex; gap:6px}
        .selectedInfo{border:1px dashed rgba(255,255,255,0.04); padding:8px; border-radius:8px}
        .muted{color:var(--muted); font-size:13px}
        input[type=range]{width:100%}
    </style>
</head>
<body>
    <div class="left">
        <h1>üåç Emoji Geo-Strategy ‚Äî –∫–∞—Ä—Ç–∞</h1>
        <div class="panel" style="margin-bottom:8px">
            <div class="controls">
                <div class="btn" id="newGameBtn">üÜï –ù–æ–≤–∞—è –∏–≥—Ä–∞</div>
                <div class="btn secondary" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</div>
                <div class="btn secondary" id="loadBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
                <div style="margin-left:auto" class="muted">Tick = <span id="tickIntervalLabel">5s</span></div>
            </div>
        </div>

        <div style="display:flex; gap:8px; margin-bottom:8px">
            <div style="flex:1" class="panel">
                <div class="muted">–í—ã–±–µ—Ä–∏ —Å—Ç—Ä–∞–Ω—É</div>
                <div class="country-list" id="countryList"></div>
            </div>
            <div style="width:220px" class="panel">
                <div class="muted">–ò–≥—Ä–æ–∫</div>
                <div class="big" id="playerName">–ò–≥—Ä–æ–∫</div>
                <div class="muted">–ë–∞–ª–∞–Ω—Å</div>
                <div class="big" id="playerMoney">0</div>
            </div>
        </div>

        <div class="map" id="map"></div>
        <div style="margin-top:8px" class="muted">–õ–µ–≥–µ–Ω–¥–∞: üü© –Ω–µ–π—Ç—Ä–∞–ª, üü¶ –≤–æ–¥–∞, üá®üá≥/... —Å—Ç—Ä–∞–Ω—ã. –ù–∞–∂–º–∏ –Ω–∞ –∫–ª–µ—Ç–∫—É –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.</div>
    </div>

    <div class="right">
        <div class="panel">
            <h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ</h1>
            <div id="selectedInfo" class="selectedInfo muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏–ª–∏ –∫–ª–µ—Ç–∫—É –∫–∞—Ä—Ç—ã.</div>
        </div>

        <div class="panel">
            <h1>–ê–ø–≥—Ä–µ–π–¥—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è</h1>
            <div id="actions">
                <div class="muted">–ù–∏ –æ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.</div>
            </div>
        </div>

        <div class="panel">
            <h1>–õ–æ–≥</h1>
            <div class="log" id="log"></div>
        </div>

        <div style="display:flex; gap:8px;">
            <div class="panel" style="flex:1">
                <div class="muted">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ / —Ö–æ–¥</div>
                <div class="big" id="incomePerTick">0</div>
            </div>
            <div class="panel" style="width:220px">
                <div class="muted">–í—Ä–µ–º—è (tick)</div>
                <div class="big" id="tickCount">0</div>
            </div>
        </div>

        <footer>–°–¥–µ–ª–∞–Ω–æ –æ–¥–Ω–∏–º html. –†–µ–¥–∞–∫—Ç–∏—Ä—É–π –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞.</footer>
    </div>

    <script>
        const CONFIG = {
            gridW: 16,
            gridH: 10,
            startMoney: 500,
            tickSeconds: 5,
            baseIncome: 5,
            infrastructureIncomeMultiplier: 10,
            infrastructureCostBase: 100,
            militaryCostBase: 80,
            unitCostBase: {ship:120, plane:200, train:90},
            policeCostBase: 150,
            revoltBaseChance: 0.5,
            policeEffectPerLevel: 0.15,
            attackIntervalSeconds: 0,
            captureTaxPercent: 0.2
        };

        const COUNTRY_OPTIONS = [
            {code:"CN", flag:"üá®üá≥", name:"–ö–∏—Ç–∞–π"},
            {code:"FR", flag:"üá´üá∑", name:"–§—Ä–∞–Ω—Ü–∏—è"},
            {code:"GB", flag:"üá¨üáß", name:"–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è"},
            {code:"PL", flag:"üáµüá±", name:"–ü–æ–ª—å—à–∞"},
            {code:"US", flag:"üá∫üá∏", name:"–°–®–ê"},
            {code:"UA", flag:"üá∫üá¶", name:"–£–∫—Ä–∞–∏–Ω–∞"},
            {code:"AE", flag:"üá¶üá™", name:"–û–ê–≠"},
            {code:"AI", flag:"üá¶üáÆ", name:"–ê–Ω–≥–∏–ª—å—è"},
            {code:"IE", flag:"üáÆüá™", name:"–ò—Ä–ª–∞–Ω–¥–∏—è"},
            {code:"IT", flag:"üáÆüáπ", name:"–ò—Ç–∞–ª–∏—è"},
            {code:"KZ", flag:"üá∞üáø", name:"–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω"},
            {code:"RU", flag:"üá∑üá∫", name:"–†–æ—Å—Å–∏—è"}
        ];

        let state = {
            grid: [],
            countries: {},
            player: {id:null, money:0, name:"–ò–≥—Ä–æ–∫", owned:[]},
            tick: 0,
            intervalId: null,
            _selectedCountry: null
        };

        const elements = {
            newGameBtn: document.getElementById('newGameBtn'),
            saveBtn: document.getElementById('saveBtn'),
            loadBtn: document.getElementById('loadBtn'),
            map: document.getElementById('map'),
            countryList: document.getElementById('countryList'),
            playerName: document.getElementById('playerName'),
            playerMoney: document.getElementById('playerMoney'),
            selectedInfo: document.getElementById('selectedInfo'),
            actions: document.getElementById('actions'),
            log: document.getElementById('log'),
            incomePerTick: document.getElementById('incomePerTick'),
            tickCount: document.getElementById('tickCount'),
            tickIntervalLabel: document.getElementById('tickIntervalLabel')
        };

        // –£—Ç–∏–ª–∏—Ç—ã
        function rnd(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
        function log(msg) {
            const l = elements.log;
            const time = new Date().toLocaleTimeString();
            l.innerHTML = `<div>(${time}) ${escapeHtml(msg)}</div>` + l.innerHTML;
            if (l.children.length > 50) l.lastChild.remove();
        }
        function escapeHtml(s) { return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;"); }
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }
        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount));
        }
        function getCountryById(id) {
            return state.countries[id];
        }
        function priceFor(base, level) {
            return Math.round(base * Math.pow(1.5, level));
        }

        // –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
        function initNewGame() {
            if (state.intervalId) clearInterval(state.intervalId);
            state = {grid:[], countries:{}, player:{id:null,money:CONFIG.startMoney,name:"–ò–≥—Ä–æ–∫",owned:[]}, tick:0, intervalId:null, _selectedCountry: null};
            const total = CONFIG.gridW * CONFIG.gridH;
            for(let i=0;i<total;i++){
                const isWater = Math.random() < 0.12;
                state.grid.push({type: isWater ? 'sea' : 'land', country:null});
            }
            const landIndices = state.grid.map((t,i)=>({t,i})).filter(x=>x.t.type==='land').map(x=>x.i);
            shuffleArray(landIndices);
            const countryCount = Math.min(COUNTRY_OPTIONS.length, Math.floor(landIndices.length * 0.2));
            for(let i=0; i<countryCount; i++) {
                const pos = landIndices[i];
                const cOpt = COUNTRY_OPTIONS[i];
                const id = cOpt.code;
                state.grid[pos].country = id;
                state.countries[id] = {
                    id, flag:cOpt.flag, name:cOpt.name,
                    pos,
                    owner: null,
                    infra: rnd(1,2),
                    military: rnd(0,2),
                    units: {ship:0, plane:0, train:0},
                    police: 0,
                    baseIncome: rnd(5,20)
                };
            }
            const firstId = Object.keys(state.countries)[0];
            if(firstId){
                state.countries[firstId].owner = 'player';
                state.player.id = 'player';
                state.player.owned = [firstId];
            }
            saveToLocalStorage('autosave', state);
            renderAll();
            startTick();
            log('–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∏–≥—Ä–∞.');
        }

        function renderAll() {
            renderCountryList();
            renderMap();
            renderPlayerInfo();
            renderSidebar();
            renderIncome();
        }

        function renderMap() {
            elements.map.innerHTML = '';
            for (let y = 0; y < CONFIG.gridH; y++) {
                const row = document.createElement('div');
                row.className = 'grid-row';
                for (let x = 0; x < CONFIG.gridW; x++) {
                    const idx = y * CONFIG.gridW + x;
                    const tile = state.grid[idx];
                    const el = document.createElement('div');
                    el.className = 'tile';
                    el.dataset.idx = idx;

                    if (tile.type === 'sea') {
                        el.innerText = 'üü¶';
                        el.classList.add('sea');
                    } else if (tile.country) {
                        const c = state.countries[tile.country];
                        el.innerText = c.flag;
                        el.classList.add('city');
                        if (c.owner && c.owner !== 'player') el.classList.add('enemy');
                    } else {
                        el.innerText = 'üü©';
                    }

                    el.onclick = () => onTileClick(idx);
                    elements.map.appendChild(el);
                }
            }
        }

        function renderCountryList() {
            elements.countryList.innerHTML = '';
            for (const id in state.countries) {
                const c = state.countries[id];
                const el = document.createElement('div');
                el.className = 'flag' + (c.owner === 'player' ? ' selected' : '');
                el.innerHTML = `${c.flag} <span class="muted" style="font-size:12px"> ${c.name}</span>`;
                el.onclick = () => selectCountry(id);
                elements.countryList.appendChild(el);
            }
        }

        function renderPlayerInfo() {
            elements.playerName.innerText = state.player.name;
            elements.playerMoney.innerText = formatMoney(state.player.money);
        }

        function renderSidebar() {
            const info = elements.selectedInfo;
            if (state._selectedCountry) {
                const c = state.countries[state._selectedCountry];
                info.classList.remove('muted');
                info.innerHTML = `<div style="display:flex;align-items:center;gap:8px">
                    <div style="font-size:28px">${c.flag}</div>
                    <div>
                        <div style="font-weight:700">${c.name} ${c.owner === 'player' ? '(–≤–∞—à–∞)' : c.owner ? '(–≤—Ä–∞–∂–¥–µ–±–Ω–∞)' : '(–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞)'}</div>
                        <div class="muted">–ò–Ω—Ñ—Ä–∞: ${c.infra} | –í–æ–µ–Ω–Ω—ã–µ: ${c.military} | üëÆ –ø–æ–ª–∏—Ü–∏—è: ${c.police}</div>
                        <div class="muted">–Æ–Ω–∏—Ç—ã: üõ≥Ô∏è${c.units.ship} ‚úàÔ∏è${c.units.plane} üöÇ${c.units.train}</div>
                        <div class="muted">–ë–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥: ${c.baseIncome} </div>
                    </div>
                </div>`;
                renderActionsFor(c);
            } else {
                info.classList.add('muted');
                info.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ —Å–ª–µ–≤–∞.';
                elements.actions.innerHTML = '<div class="muted">–ù–∏ –æ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.</div>';
            }
        }

        function renderActionsFor(country) {
            const a = elements.actions;
            a.innerHTML = '';
            
            if (country.owner === 'player') {
                a.innerHTML = `
                <div class="upgrade-panel">
                    <div class="row" style="margin-bottom:6px">
                        <div style="flex:1">
                            <div class="muted">–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ üè≠ (–¥–æ—Ö–æ–¥)</div>
                            <div class="upgrade">
                                <div>–£—Ä–æ–≤–µ–Ω—å: ${country.infra}</div>
                                <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatMoney(priceFor(CONFIG.infrastructureCostBase, country.infra))}</div>
                            </div>
                        </div>
                        <div style="width:140px; display:flex; flex-direction:column; gap:6px">
                            <button class="btn" id="buyInfra" data-type="infra">–ö—É–ø–∏—Ç—å</button>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom:6px">
                        <div style="flex:1">
                            <div class="muted">–í–æ–µ–Ω–Ω—ã–µ üíÇ (—Å–∏–ª–∞ –∞—Ç–∞–∫–∏)</div>
                            <div class="upgrade">
                                <div>–£—Ä–æ–≤–µ–Ω—å: ${country.military}</div>
                                <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatMoney(priceFor(CONFIG.militaryCostBase, country.military))}</div>
                            </div>
                        </div>
                        <div style="width:140px; display:flex; flex-direction:column; gap:6px">
                            <button class="btn" id="buyMilitary" data-type="military">–ù–∞–±—Ä–∞—Ç—å</button>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:6px">
                        <div style="flex:1">
                            <div class="muted">–Æ–Ω–∏—Ç—ã</div>
                            <div class="upgrade">üõ≥Ô∏è ${country.units.ship} | ‚úàÔ∏è ${country.units.plane} | üöÇ ${country.units.train}</div>
                        </div>
                        <div style="width:140px;display:flex;flex-direction:column;gap:6px">
                            <button class="btn" id="buyShip">–ö—É–ø–∏—Ç—å üõ≥Ô∏è (${CONFIG.unitCostBase.ship})</button>
                            <button class="btn" id="buyPlane">–ö—É–ø–∏—Ç—å ‚úàÔ∏è (${CONFIG.unitCostBase.plane})</button>
                            <button class="btn" id="buyTrain">–ö—É–ø–∏—Ç—å üöÇ (${CONFIG.unitCostBase.train})</button>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:6px">
                        <div style="flex:1">
                            <div class="muted">–ü–æ–ª–∏—Ü–∏—è üëÆ (–º–µ–Ω—å—à–µ –±—É–Ω—Ç–æ–≤)</div>
                            <div class="upgrade">–£—Ä–æ–≤–µ–Ω—å: ${country.police} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatMoney(priceFor(CONFIG.policeCostBase, country.police))}</div>
                        </div>
                        <div style="width:140px;display:flex;flex-direction:column;gap:6px">
                            <button class="btn" id="buyPolice">–ù–∞–Ω—è—Ç—å üëÆ</button>
                        </div>
                    </div>
                </div>`;

                document.getElementById('buyInfra').onclick = () => upgradeCountry(country, 'infra');
                document.getElementById('buyMilitary').onclick = () => upgradeCountry(country, 'military');
                document.getElementById('buyShip').onclick = () => buyUnit(country, 'ship');
                document.getElementById('buyPlane').onclick = () => buyUnit(country, 'plane');
                document.getElementById('buyTrain').onclick = () => buyUnit(country, 'train');
                document.getElementById('buyPolice').onclick = () => upgradeCountry(country, 'police');

            } else {
                // Actions for neutral/enemy countries
                const playerOwnedCountries = state.player.owned;
                const canAttack = playerOwnedCountries.some(id => getNeighboringCountries(id).includes(country.id));

                a.innerHTML = `
                <div class="attack-panel">
                    <button class="btn" id="attackBtn" ${canAttack ? '' : 'disabled'}>‚öîÔ∏è –ù–∞–ø–∞—Å—Ç—å</button>
                    ${!canAttack ? '<div class="muted" style="margin-top:8px;">–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∞—Å—Ç—å –Ω–∞ —ç—Ç—É —Å—Ç—Ä–∞–Ω—É, —Ç–∞–∫ –∫–∞–∫ —É –≤–∞—Å –Ω–µ—Ç —Å–æ—Å–µ–¥–Ω–∏—Ö —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π.</div>' : ''}
                </div>`;
                if (canAttack) {
                    document.getElementById('attackBtn').onclick = () => onAttack(country);
                }
            }
        }
        
        function upgradeCountry(country, type) {
            let cost, level;
            switch(type) {
                case 'infra':
                    level = country.infra;
                    cost = priceFor(CONFIG.infrastructureCostBase, level);
                    if (state.player.money < cost) { alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
                    state.player.money -= cost;
                    country.infra += 1;
                    log(`–í—ã –ø—Ä–æ–∫–∞—á–∞–ª–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ ${country.name} (—É—Ä–æ–≤–µ–Ω—å ${country.infra}).`);
                    break;
                case 'military':
                    level = country.military;
                    cost = priceFor(CONFIG.militaryCostBase, level);
                    if (state.player.money < cost) { alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
                    state.player.money -= cost;
                    country.military += 1;
                    log(`–í—ã —É–≤–µ–ª–∏—á–∏–ª–∏ –≤–æ–µ–Ω–Ω—É—é —Å–∏–ª—É ${country.name} –¥–æ ${country.military}.`);
                    break;
                case 'police':
                    level = country.police;
                    cost = priceFor(CONFIG.policeCostBase, level);
                    if (state.player.money < cost) { alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
                    state.player.money -= cost;
                    country.police += 1;
                    log(`–í—ã –Ω–∞–Ω—è–ª–∏ –ø–æ–ª–∏—Ü–∏—é –≤ ${country.name} (—É—Ä–æ–≤–µ–Ω—å ${country.police}).`);
                    break;
            }
            saveToLocalStorage('autosave', state);
            renderAll();
        }

        function buyUnit(country, type) {
            const cost = CONFIG.unitCostBase[type];
            if (state.player.m
