<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>–°—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äî –∑–∞—Ö–≤–∞—Ç —Å—Ç—Ä–∞–Ω</title>
<style>
  body {
    margin:0; padding:0; font-family: Arial, sans-serif;
    background: #e1f0ff;
    user-select:none;
    display:flex; flex-direction: column; align-items:center;
  }
  #screenChoose, #screenGame {
    width: 100%; max-width: 600px; padding: 10px; box-sizing: border-box;
  }
  #screenChoose {
    margin-top: 40px;
    text-align: center;
  }
  #screenChoose h2 {
    margin-bottom: 20px;
  }
  .flag-select {
    font-size: 40px; cursor:pointer; margin: 8px;
    display: inline-block; user-select:none;
    transition: transform 0.2s;
  }
  .flag-select:hover {
    transform: scale(1.3);
  }
  #btnStart {
    margin-top: 30px;
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
    background: #3a86ff;
    color: white;
    border: none;
    border-radius: 8px;
    user-select:none;
  }

  #headerGame {
    display:flex; justify-content: space-between; align-items:center;
    background:#3a86ff; color:#fff; padding:10px 20px; border-radius: 8px 8px 0 0;
  }
  #headerGame div {
    font-size: 18px;
    font-weight: 700;
  }

  #map {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 2px;
    margin-top: 10px;
    user-select:none;
  }
  .map-cell {
    width: 38px; height: 38px;
    font-size: 28px;
    line-height: 38px;
    text-align: center;
    cursor: pointer;
    border-radius: 6px;
    background: #a0d8ff;
    transition: background-color 0.3s;
    user-select:none;
  }
  .map-cell.neutral {
    background: #c8c8c8;
    cursor: default;
  }
  .map-cell.owned {
    background: #7bd47b;
  }
  .map-cell.enemy {
    background: #e27a7a;
  }
  .map-cell:hover {
    filter: brightness(1.15);
  }

  #infoPanel {
    margin-top: 15px;
    background: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
  }

  #stats, #upgradePanel, #attackPanel, #logPanel {
    margin-top: 15px;
  }

  #stats div, #upgradePanel div, #attackPanel div {
    margin-bottom: 8px;
  }

  button {
    cursor: pointer;
    padding: 6px 12px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    background: #3a86ff;
    color: white;
    transition: background-color 0.3s;
    user-select:none;
  }
  button:disabled {
    background: #999;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #265bb5;
  }

  #logPanel {
    max-height: 120px;
    overflow-y: auto;
    background: #eef6ff;
    padding: 8px;
    border-radius: 8px;
    font-size: 14px;
    user-select:none;
  }

  .emoji {
    margin-right: 6px;
    font-size: 20px;
  }
</style>
</head>
<body>

<div id="screenChoose">
  <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –Ω–∞—á–∞–ª–∞</h2>
  <div id="flagsContainer"></div>
  <button id="btnStart" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
</div>

<div id="screenGame" style="display:none;">
  <div id="headerGame">
    <div>–ë–∞–ª–∞–Ω—Å: <span id="balance">1000</span> üí∞</div>
    <div>–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∞: <span id="playerCountryFlag"></span> <span id="playerCountryName"></span></div>
  </div>

  <div id="map" title="–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞ ‚Äî –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —Å—Ç—Ä–∞–Ω–µ"></div>

  <div id="infoPanel">
    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–∞–Ω–µ <span id="infoFlag"></span> <span id="infoName"></span></h3>
    <div id="stats"></div>

    <div id="upgradePanel">
      <h4>–ü—Ä–æ–∫–∞—á–∞—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –∞—Ä–º–∏—é</h4>
      <div><button data-upgrade="economy">üè≠ –≠–∫–æ–Ω–æ–º–∏–∫–∞ (+10% –¥–æ—Ö–æ–¥) ‚Äî 200 üí∞</button></div>
      <div><button data-upgrade="army">üíÇ –ê—Ä–º–∏—è (+10% —Å–∏–ª—ã) ‚Äî 200 üí∞</button></div>
      <div><button data-upgrade="navy">üõ≥Ô∏è –§–ª–æ—Ç (+10% —Å–∏–ª—ã) ‚Äî 200 üí∞</button></div>
      <div><button data-upgrade="airforce">‚úàÔ∏è –ê–≤–∏–∞—Ü–∏—è (+10% —Å–∏–ª—ã) ‚Äî 200 üí∞</button></div>
      <div><button data-upgrade="railway">üöÇ –ñ–µ–ª–µ–∑–Ω–∞—è –¥–æ—Ä–æ–≥–∞ (+10% –¥–æ—Ö–æ–¥) ‚Äî 200 üí∞</button></div>
      <div><button data-upgrade="police">üëÆ –ü–æ–ª–∏—Ü–∏—è (—É–º–µ–Ω—å—à–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∏—è) ‚Äî 200 üí∞</button></div>
    </div>

    <div id="attackPanel" style="margin-top: 20px;">
      <h4>–ù–∞–ø–∞—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω—É</h4>
      <button id="btnAttack" disabled>–ù–∞–ø–∞—Å—Ç—å</button>
    </div>

    <div id="logPanel">
      <h4>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h4>
      <div id="logMessages"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const countries = [
    {id:'CN', name:'–ö–∏—Ç–∞–π', flag:'üá®üá≥'},
    {id:'FR', name:'–§—Ä–∞–Ω—Ü–∏—è', flag:'üá´üá∑'},
    {id:'GB', name:'–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', flag:'üá¨üáß'},
    {id:'PL', name:'–ü–æ–ª—å—à–∞', flag:'üáµüá±'},
    {id:'UM', name:'–û—Å—Ç—Ä–æ–≤–∞ –°–®–ê', flag:'üá∫üá≤'},
    {id:'UA', name:'–£–∫—Ä–∞–∏–Ω–∞', flag:'üá∫üá¶'},
    {id:'AE', name:'–û–ê–≠', flag:'üá¶üá™'},
    {id:'IE', name:'–ò—Ä–ª–∞–Ω–¥–∏—è', flag:'üáÆüá™'},
    {id:'IT', name:'–ò—Ç–∞–ª–∏—è', flag:'üáÆüáπ'},
    {id:'KZ', name:'–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', flag:'üá∞üáø'},
    {id:'RU', name:'–†–æ—Å—Å–∏—è', flag:'üá∑üá∫'},
  ];

  const mapGrid = [
    [null, 'RU',  null, 'CN',  null, 'KZ',  null,  null,  'PL', null,  'GB', null],
    ['RU',  'RU', 'RU',  'CN',  'CN', 'KZ',  null,  null,  'PL', 'PL', 'GB', null],
    [null, 'RU',  null, 'CN',  null, null,  null,  null,  null, 'PL', 'GB', 'FR'],
    [null, null,  null, null,  null, null,  null,  null,  null, null, 'IE', 'FR'],
    [null, 'UM',  null, null,  'AE', null,  null,  'IE', 'IE', 'IT', 'IT', null],
    [null, 'UM',  null, null,  'AE', null,  null,  null, 'IE', 'IT',  null, null],
  ];

  const state = {};
  countries.forEach(c => {
    state[c.id] = {
      owner: null,
      economyLevel: 1,
      armyLevel: 1,
      navyLevel: 1,
      airforceLevel: 1,
      railwayLevel: 1,
      policeLevel: 1,
      baseIncome: 100,
      isCaptured: false,
    };
  });

  let playerCountryId = null;
  let balance = 1000;
  let selectedCountryId = null;

  const screenChoose = document.getElementById('screenChoose');
  const flagsContainer = document.getElementById('flagsContainer');
  const btnStart = document.getElementById('btnStart');

  const screenGame = document.getElementById('screenGame');
  const playerCountryFlag = document.getElementById('playerCountryFlag');
  const playerCountryName = document.getElementById('playerCountryName');
  const balanceElem = document.getElementById('balance');
  const mapElem = document.getElementById('map');
  const infoFlag = document.getElementById('infoFlag');
  const infoName = document.getElementById('infoName');
  const statsElem = document.getElementById('stats');
  const upgradePanel = document.getElementById('upgradePanel');
  const attackPanel = document.getElementById('attackPanel');
  const btnAttack = document.getElementById('btnAttack');
  const logMessages = document.getElementById('logMessages');

  // –°–æ–∑–¥–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã
  countries.forEach(c => {
    const span = document.createElement('span');
    span.className = 'flag-select';
    span.textContent = c.flag;
    span.title = c.name;
    span.dataset.id = c.id;
    flagsContainer.appendChild(span);
  });

  // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã –∏–≥—Ä–æ–∫–æ–º
  flagsContainer.addEventListener('click', e => {
    if(e.target.classList.contains('flag-select')) {
      flagsContainer.querySelectorAll('.flag-select').forEach(el => el.style.border = '');
      e.target.style.border = '3px solid #3a86ff';
      playerCountryId = e.target.dataset.id;
      btnStart.disabled = false;
    }
  });

  btnStart.addEventListener('click', () => {
    if(!playerCountryId) return;
    state[playerCountryId].owner = 'player';
    state[playerCountryId].isCaptured = true;
    selectedCountryId = playerCountryId;
    
    // Choose an AI country to start with
    const availableAI = countries.filter(c => c.id !== playerCountryId && c.id !== 'UA' && c.id !== 'IE');
    const aiCountry = availableAI[Math.floor(Math.random() * availableAI.length)];
    if (aiCountry) {
        state[aiCountry.id].owner = 'AI';
        state[aiCountry.id].isCaptured = true;
    }

    screenChoose.style.display = 'none';
    screenGame.style.display = 'block';

    updateUI();
    logAdd(`–í—ã –Ω–∞—á–∞–ª–∏ –∏–≥—Ä—É –∑–∞ —Å—Ç—Ä–∞–Ω—É ${getCountryById(playerCountryId).name}`);
    startGameLoop(); // Start the game loop
  });

  // Attach upgrade button event listeners
  upgradePanel.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if(btn && !btn.disabled) {
        const upgradeType = btn.dataset.upgrade;
        const cost = 200;
        if(balance >= cost) {
            balance -= cost;
            state[selectedCountryId][`${upgradeType}Level`]++;
            updateUI();
            logAdd(`–ü—Ä–æ–∫–∞—á–∞–Ω–∞ ${upgradeType} –¥–ª—è ${getCountryById(selectedCountryId).name}`);
        }
    }
  });

  // Attach attack button event listener
  btnAttack.addEventListener('click', () => {
    if (selectedCountryId && selectedCountryId !== playerCountryId && btnAttack.disabled === false) {
      const attackerCountryId = playerCountryId;
      const defenderCountryId = selectedCountryId;
      const attackerState = state[attackerCountryId];
      const defenderState = state[defenderCountryId];

      const attackerStrength = attackerState.armyLevel * 100 + attackerState.airforceLevel * 50 + attackerState.navyLevel * 50;
      const defenderStrength = defenderState.armyLevel * 100 + defenderState.airforceLevel * 50 + defenderState.navyLevel * 50;

      const randomFactor = Math.random() * 0.5 + 0.75; // Random factor between 0.75 and 1.25
      const totalAttackerStrength = attackerStrength * randomFactor;
      const totalDefenderStrength = defenderStrength * randomFactor;
      
      const policeEffect = defenderState.policeLevel * 10;
      const finalDefenderStrength = totalDefenderStrength + policeEffect;

      if (totalAttackerStrength > finalDefenderStrength) {
          defenderState.owner = 'player';
          defenderState.isCaptured = true;
          logAdd(`üéâ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ ${getCountryById(defenderCountryId).name}!`);
      } else {
          logAdd(`‚ùå –ù–∞–ø–∞–¥–µ–Ω–∏–µ –Ω–∞ ${getCountryById(defenderCountryId).name} –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å.`);
      }
      updateUI();
    }
  });
  
  function getCountryById(id) {
    return countries.find(c => c.id === id);
  }

  function getNeighboringCountries(countryId) {
    const neighbors = new Set();
    const visited = new Set();
    
    // Find all cells of the country on the map
    const countryCells = [];
    for (let r = 0; r < mapGrid.length; r++) {
        for (let c = 0; c < mapGrid[r].length; c++) {
            if (mapGrid[r][c] === countryId) {
                countryCells.push({r, c});
            }
        }
    }

    // Check adjacent cells for neighbors
    countryCells.forEach(cell => {
        const { r, c } = cell;
        const directions = [
            { dr: -1, dc: 0 }, { dr: 1, dc: 0 },
            { dr: 0, dc: -1 }, { dr: 0, dc: 1 }
        ];

        directions.forEach(dir => {
            const newR = r + dir.dr;
            const newC = c + dir.dc;

            if (newR >= 0 && newR < mapGrid.length && newC >= 0 && newC < mapGrid[0].length) {
                const neighborId = mapGrid[newR][newC];
                if (neighborId && neighborId !== countryId && !visited.has(neighborId)) {
                    neighbors.add(neighborId);
                    visited.add(neighborId);
                }
            }
        });
    });

    return Array.from(neighbors);
  }


  function updateUI() {
    balanceElem.textContent = balance;
    playerCountryFlag.textContent = getCountryById(playerCountryId)?.flag || '';
    playerCountryName.textContent = getCountryById(playerCountryId)?.name || '';

    renderMap();
    renderSelectedCountry();
    updateAttackButton();
  }

  function renderMap() {
    mapElem.innerHTML = '';
    for(let r=0; r<mapGrid.length; r++) {
      for(let c=0; c<mapGrid[r].length; c++) {
        const cellCountryId = mapGrid[r][c];
        const cell = document.createElement('div');
        cell.className = 'map-cell';
        if(cellCountryId === null) {
          cell.classList.add('neutral');
          cell.textContent = 'üü¶';
          cell.title = '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è';
          cell.dataset.id = '';
          cell.style.cursor = 'default';
        } else {
          const country = getCountryById(cellCountryId);
          const st = state[cellCountryId];
          cell.textContent = country.flag;
          cell.title = `${country.name} (${st.owner === 'player' ? '–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∞' : st.owner === 'AI' ? '–í—Ä–∞–≥' : '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è'})`;
          cell.dataset.id = cellCountryId;

          if(st.owner === 'player') cell.classList.add('owned');
          else if(st.owner === 'AI') cell.classList.add('enemy');
          else if (!st.isCaptured) { // Neutral countries
            cell.style.backgroundColor = '#a0d8ff';
          }
        }
        cell.addEventListener('click', () => {
          if(cell.dataset.id) {
            selectedCountryId = cell.dataset.id;
            renderSelectedCountry();
            updateAttackButton();
          }
        });
        mapElem.appendChild(cell);
      }
    }
  }

  function renderSelectedCountry() {
    if(!selectedCountryId) {
      infoFlag.textContent = '';
      infoName.textContent = '';
      statsElem.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –Ω–∞ –∫–∞—Ä—Ç–µ';
      upgradePanel.style.display = 'none';
      attackPanel.style.display = 'none';
      return;
    }
    const c = getCountryById(selectedCountryId);
    const st = state[selectedCountryId];
    infoFlag.textContent = c.flag;
    infoName.textContent = c.name;

    let ownerStr = st.owner === 'player' ? '–í—ã' : st.owner === 'AI' ? '–í—Ä–∞–≥' : '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è';
    let capturedStr = st.isCaptured ? '–ó–∞—Ö–≤–∞—á–µ–Ω–∞' : '–°–≤–æ–±–æ–¥–Ω–∞';

    statsElem.innerHTML = `
      <div>–í–ª–∞–¥–µ–ª–µ—Ü: <b>${ownerStr}</b></div>
      <div>–°–æ—Å—Ç–æ—è–Ω–∏–µ: <b>${capturedStr}</b></div>
      <div>–≠–∫–æ–Ω–æ–º–∏–∫–∞: ${st.economyLevel} (–¥–æ—Ö–æ–¥: ${calculateIncome(selectedCountryId)})</div>
      <div>–ê—Ä–º–∏—è: ${st.armyLevel}</div>
      <div>–§–ª–æ—Ç: ${st.navyLevel}</div>
      <div>–ê–≤–∏–∞—Ü–∏—è: ${st.airforceLevel}</div>
      <div>–ñ–µ–ª–µ–∑–Ω–∞—è –¥–æ—Ä–æ–≥–∞: ${st.railwayLevel}</div>
      <div>–ü–æ–ª–∏—Ü–∏—è: ${st.policeLevel}</div>
    `;

    if(st.owner === 'player') {
      upgradePanel.style.display = 'block';
      attackPanel.style.display = 'none';
      Array.from(upgradePanel.querySelectorAll('button')).forEach(btn => {
        btn.disabled = balance < 200;
      });
    } else {
      upgradePanel.style.display = 'none';
      attackPanel.style.display = 'block';
    }
    updateAttackButton();
  }

  function calculateIncome(countryId) {
    const st = state[countryId];
    if (st.owner !== 'player') return 0;
    return Math.floor(st.baseIncome * (1 + 0.1 * (st.economyLevel - 1)) * (1 + 0.1 * (st.railwayLevel -1)));
  }

  function updateAttackButton() {
    if (!selectedCountryId || selectedCountryId === playerCountryId) {
      btnAttack.disabled = true;
      return;
    }
    
    const selectedCountryState = state[selectedCountryId];
    if (selectedCountryState.owner === 'player') {
        btnAttack.disabled = true;
        return;
    }
    
    const playerOwnedCountries = Object.keys(state).filter(id => state[id].owner === 'player');
    let canAttack = false;
    for (const ownedId of playerOwnedCountries) {
        const neighbors = getNeighboringCountries(ownedId);
        if (neighbors.includes(selectedCountryId)) {
            canAttack = true;
            break;
        }
    }
    
    btnAttack.disabled = !canAttack;
  }
  
  function logAdd(message) {
      const p = document.createElement('p');
      p.innerHTML = message;
      logMessages.prepend(p);
      if (logMessages.children.length > 5) {
          logMessages.lastChild.remove();
      }
  }
  
  // Game loop to simulate turns
  function startGameLoop() {
      setInterval(() => {
          // Player income
          let totalIncome = 0;
          Object.keys(state).forEach(id => {
              if (state[id].owner === 'player') {
                  totalIncome += calculateIncome(id);
              }
          });
          balance += totalIncome;
          logAdd(`üí∞ –ü–æ–ª—É—á–µ–Ω–æ ${totalIncome} –æ—Ç –≤–∞—à–∏—Ö —Å—Ç—Ä–∞–Ω.`);
          
          // AI Turn (simple logic for now)
          const aiCountries = Object.keys(state).filter(id => state[id].owner === 'AI');
          aiCountries.forEach(aiId => {
              const neighbors = getNeighboringCountries(aiId);
              const neutralNeighbors = neighbors.filter(id => state[id].owner === null);
              if (neutralNeighbors.length > 0) {
                  const targetCountryId = neutralNeighbors[Math.floor(Math.random() * neutralNeighbors.length)];
                  state[targetCountryId].owner = 'AI';
                  state[targetCountryId].isCaptured = true;
                  logAdd(`–í—Ä–∞–≥ –∑–∞—Ö–≤–∞—Ç–∏–ª ${getCountryById(targetCountryId).name}!`);
              }
          });
          
          updateUI();
      }, 5000); // Every 5 seconds
  }
})();
</script>
</body>
                              </html>
  
